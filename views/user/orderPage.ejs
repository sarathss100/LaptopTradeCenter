<!DOCTYPE html>
<html lang="en">
  <head>
    <!-- Header section boiler plate -->
    <%- include('components/headboilerplate') %>
  </head>
  <body class="flex flex-col min-h-screen">
    <!-- Navbar Section -->
    <%- include('components/navbar') %>

    <!-- Main Content Section -->
    <main class="flex flex-row flex-grow justify-start">
      <!-- Main Side Section -->
      <%- include('components/sidebar') %>

      <!-- Confirmation Modal for cancel Order -->
      <div
        id="confirmationModal"
        class="hidden fixed inset-0 p-4 flex flex-wrap justify-center items-center w-full h-full z-[1000] before:fixed before:inset-0 before:w-full before:h-full before:bg-[rgba(0,0,0,0.5)] overflow-auto font-[sans-serif]"
      >
        <div class="w-full max-w-md bg-white shadow-lg rounded-xl p-6 relative">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            class="w-3.5 cursor-pointer shrink-0 fill-gray-400 hover:fill-red-500 float-right"
            viewBox="0 0 320.591 320.591"
          >
            <path
              d="M30.391 318.583a30.37 30.37 0 0 1-21.56-7.288c-11.774-11.844-11.774-30.973 0-42.817L266.643 10.665c12.246-11.459 31.462-10.822 42.921 1.424 10.362 11.074 10.966 28.095 1.414 39.875L51.647 311.295a30.366 30.366 0 0 1-21.256 7.288z"
              data-original="#000000"
            ></path>
            <path
              d="M287.9 318.583a30.37 30.37 0 0 1-21.257-8.806L8.83 51.963C-2.078 39.225-.595 20.055 12.143 9.146c11.369-9.736 28.136-9.736 39.504 0l259.331 257.813c12.243 11.462 12.876 30.679 1.414 42.922-.456.487-.927.958-1.414 1.414a30.368 30.368 0 0 1-23.078 7.288z"
              data-original="#000000"
            ></path>
          </svg>

          <div class="my-8 text-center">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="w-14 fill-red-500 inline"
              viewBox="0 0 286.054 286.054"
            >
              <path
                fill="#e2574c"
                d="M143.027 0C64.04 0 0 64.04 0 143.027c0 78.996 64.04 143.027 143.027 143.027 78.996 0 143.027-64.022 143.027-143.027C286.054 64.04 222.022 0 143.027 0zm0 259.236c-64.183 0-116.209-52.026-116.209-116.209S78.844 26.818 143.027 26.818s116.209 52.026 116.209 116.209-52.026 116.209-116.209 116.209zm.009-196.51c-10.244 0-17.995 5.346-17.995 13.981v79.201c0 8.644 7.75 13.972 17.995 13.972 9.994 0 17.995-5.551 17.995-13.972V76.707c-.001-8.43-8.001-13.981-17.995-13.981zm0 124.997c-9.842 0-17.852 8.01-17.852 17.86 0 9.833 8.01 17.843 17.852 17.843s17.843-8.01 17.843-17.843c-.001-9.851-8.001-17.86-17.843-17.86z"
                data-original="#e2574c"
              />
            </svg>

            <h4 class="text-lg text-gray-800 font-semibold mt-6">
              Your order will be cancelled permanently!
            </h4>
            <p class="text-sm text-gray-500 mt-2">Are you sure to proceed?</p>
          </div>

          <div class="flex max-sm:flex-col gap-4">
            <button
              id="cancelButton"
              type="button"
              class="px-5 py-2.5 rounded-lg w-full tracking-wide text-gray-800 text-sm border-none outline-none bg-gray-200 hover:bg-gray-300"
            >
              I am not sure
            </button>
            <button
              id="confirmButton"
              type="button"
              class="px-5 py-2.5 rounded-lg w-full tracking-wide text-white text-sm border-none outline-none bg-red-500 hover:bg-red-600"
            >
              Cancel Order
            </button>
          </div>
        </div>
      </div>

      <!-- Main Body Section -->
      <div class="w-full md:w-4/5 ml-6 mt-6">
        <div class="flex">
          <h1 class="font-semibold text-2xl">Order History</h1>
        </div>

        <% for ( let i = 0; i < orderDetails.length; i++ ) { %> <% for ( let j =
        0; j < orderDetails[i].products.length; j++ ) { %>
        <div
          class="bg-white flex flex-col md:flex-row shadow-xl w-11/12 rounded-lg font-[sans-serif] overflow-hidden mt-4"
        >
          <div
            class="flex items-center justify-center md:justify-center min-w-[200px]"
          >
            <a
              href="/user/productDetailPage/<%= orderDetails[i].products[j].product._id%>"
            >
              <img
                src="data:<%= orderDetails[i].products[j].product.product_images.contentType %>;base64,<%= orderDetails[i].products[j].product.product_images.data.toString('base64') %>"
                class="text-center h-40 w-44 object-fill"
              />
            </a>
          </div>

          <div class="flex flex-col p-3 items-center md:items-start w-full">
            <div>
              <h3 class="text-xl font-semibold w-full text-center md:text-left">
                <%=orderDetails[i].products[j].product.product_brand%>
                <%=orderDetails[i].products[j].product.product_name%>
                <%=orderDetails[i].products[j].product.processor%>
                <%=orderDetails[i].products[j].product.processor_generation%>
                <%=orderDetails[i].products[j].product.product_model%>
              </h3>
            </div>

            <div class="flex items-center">
              <svg
                class="w-4 h-4 text-yellow-300 ms-1"
                aria-hidden="true"
                xmlns="http://www.w3.org/2000/svg"
                fill="currentColor"
                viewBox="0 0 22 20"
              >
                <path
                  d="M20.924 7.625a1.523 1.523 0 0 0-1.238-1.044l-5.051-.734-2.259-4.577a1.534 1.534 0 0 0-2.752 0L7.365 5.847l-5.051.734A1.535 1.535 0 0 0 1.463 9.2l3.656 3.563-.863 5.031a1.532 1.532 0 0 0 2.226 1.616L11 17.033l4.518 2.375a1.534 1.534 0 0 0 2.226-1.617l-.863-5.03L20.537 9.2a1.523 1.523 0 0 0 .387-1.575Z"
                />
              </svg>
              <svg
                class="w-4 h-4 text-yellow-300 ms-1"
                aria-hidden="true"
                xmlns="http://www.w3.org/2000/svg"
                fill="currentColor"
                viewBox="0 0 22 20"
              >
                <path
                  d="M20.924 7.625a1.523 1.523 0 0 0-1.238-1.044l-5.051-.734-2.259-4.577a1.534 1.534 0 0 0-2.752 0L7.365 5.847l-5.051.734A1.535 1.535 0 0 0 1.463 9.2l3.656 3.563-.863 5.031a1.532 1.532 0 0 0 2.226 1.616L11 17.033l4.518 2.375a1.534 1.534 0 0 0 2.226-1.617l-.863-5.03L20.537 9.2a1.523 1.523 0 0 0 .387-1.575Z"
                />
              </svg>
              <svg
                class="w-4 h-4 text-yellow-300 ms-1"
                aria-hidden="true"
                xmlns="http://www.w3.org/2000/svg"
                fill="currentColor"
                viewBox="0 0 22 20"
              >
                <path
                  d="M20.924 7.625a1.523 1.523 0 0 0-1.238-1.044l-5.051-.734-2.259-4.577a1.534 1.534 0 0 0-2.752 0L7.365 5.847l-5.051.734A1.535 1.535 0 0 0 1.463 9.2l3.656 3.563-.863 5.031a1.532 1.532 0 0 0 2.226 1.616L11 17.033l4.518 2.375a1.534 1.534 0 0 0 2.226-1.617l-.863-5.03L20.537 9.2a1.523 1.523 0 0 0 .387-1.575Z"
                />
              </svg>
              <svg
                class="w-4 h-4 text-yellow-300 ms-1"
                aria-hidden="true"
                xmlns="http://www.w3.org/2000/svg"
                fill="currentColor"
                viewBox="0 0 22 20"
              >
                <path
                  d="M20.924 7.625a1.523 1.523 0 0 0-1.238-1.044l-5.051-.734-2.259-4.577a1.534 1.534 0 0 0-2.752 0L7.365 5.847l-5.051.734A1.535 1.535 0 0 0 1.463 9.2l3.656 3.563-.863 5.031a1.532 1.532 0 0 0 2.226 1.616L11 17.033l4.518 2.375a1.534 1.534 0 0 0 2.226-1.617l-.863-5.03L20.537 9.2a1.523 1.523 0 0 0 .387-1.575Z"
                />
              </svg>
              <svg
                class="w-4 h-4 ms-1 text-gray-300 dark:text-gray-500"
                aria-hidden="true"
                xmlns="http://www.w3.org/2000/svg"
                fill="currentColor"
                viewBox="0 0 22 20"
              >
                <path
                  d="M20.924 7.625a1.523 1.523 0 0 0-1.238-1.044l-5.051-.734-2.259-4.577a1.534 1.534 0 0 0-2.752 0L7.365 5.847l-5.051.734A1.535 1.535 0 0 0 1.463 9.2l3.656 3.563-.863 5.031a1.532 1.532 0 0 0 2.226 1.616L11 17.033l4.518 2.375a1.534 1.534 0 0 0 2.226-1.617l-.863-5.03L20.537 9.2a1.523 1.523 0 0 0 .387-1.575Z"
                />
              </svg>
            </div>

            <p class="text-sm text-gray-400">1000 Ratings & 500 Reviews</p>
            <p
              class="text-sm text-black leading-relaxed text-center md:text-left break-words max-w-full"
            >
              <%=orderDetails[i].products[j].product.processor%>
              <%=orderDetails[i].products[j].product.processor_generation%>
            </p>
            <p
              class="text-sm text-black leading-relaxed text-center md:text-left break-words max-w-full"
            >
              <%=orderDetails[i].products[j].product.ram_capacity%>
              <%=orderDetails[i].products[j].product.ram_generation%>
            </p>

            <p
              class="text-sm text-black leading-relaxed text-center md:text-left break-words max-w-full"
            >
              <%=orderDetails[i].products[j].product.storage_type%>
            </p>

            <p
              class="text-sm text-black leading-relaxed text-center md:text-left break-words max-w-full"
            >
              <%=orderDetails[i].products[j].product.operating_system%>
              Operating System
            </p>

            <p
              class="text-sm text-black leading-relaxed text-center md:text-left w-full"
            >
              1 Year Onsite Warranty
            </p>
            <div>
              <% if ( orderDetails[i].products[j].orderStatus === 'Cancelled' )
              { %>
              <p
                class="text-sm text-black leading-relaxed text-center md:text-left w-full"
              >
                Order Cancelled
              </p>
              <% } else { %>

              <p
                class="text-sm text-black leading-relaxed text-center md:text-left w-full"
              >
                <%=orderDetails[i].products[j].orderStatus%>
              </p>
              <% } %> <% if ( orderDetails[i].products[j].orderStatus ===
              'Delivered' ) { %>
              <a
                href=""
                class="text-sm text-red-600 underline leading-relaxed text-center md:text-left break-words w-full"
                >Return</a
              >
              <% } %> <% if ( orderDetails[i].products[j].orderStatus !==
              'Delivered' && orderDetails[i].products[j].orderStatus !==
              'Cancelled' ) { %>

              <a
                id="cancel-order-<%=orderDetails[i]._id%>"
                href="#"
                data-order-id="<%=orderDetails[i]._id%>"
                data-product-id="<%=orderDetails[i].products[j]._id%>"
                class="text-sm text-red-600 underline leading-relaxed text-center md:text-left break-words w-full"
                >Cancel Order</a
              >

              <% } %>
            </div>
          </div>
        </div>
        <% } %> <% } %>
      </div>
    </main>

    <!-- Footer Section -->
    <%- include('components/footer') %>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const cancelLinks = document.querySelectorAll("a[id^='cancel-order-']");
        const confirmationModal = document.getElementById("confirmationModal");
        const closeModalButton = document.querySelector(
          "#confirmationModal svg"
        );
        const cancelButton = document.getElementById("cancelButton");
        const confirmButton = document.getElementById("confirmButton");
        let selectedLink = null;

        // Show the confirmation modal
        cancelLinks.forEach((link) => {
          link.addEventListener("click", function (event) {
            event.preventDefault();
            selectedLink = this;
            confirmationModal.classList.remove("hidden");
          });
        });

        // Close the modal without action
        closeModalButton.addEventListener("click", () => {
          confirmationModal.classList.add("hidden");
        });

        cancelButton.addEventListener("click", () => {
          confirmationModal.classList.add("hidden");
        });

        // Confirm the cancellation
        confirmButton.addEventListener("click", () => {
          if (selectedLink) {
            const orderId = selectedLink.getAttribute("data-order-id");
            const productId = selectedLink.getAttribute("data-product-id");

            // Send AJAX request to cancel the order
            fetch(`/user/cancelOrder/${orderId}?productId=${productId}`, {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
            })
              .then((response) => response.json())
              .then((data) => {
                if (data.success) {
                  // Update the UI to reflect the cancellation
                  if (selectedLink && selectedLink.parentElement) {
                    selectedLink.parentElement.innerHTML =
                      '<p class="text-sm text-black leading-relaxed text-center md:text-left w-full">Order Cancelled</p>';
                  } else {
                    console.error("Parent element not found for selectedLink.");
                  }
                } else {
                  alert(`Failed to cancel the order. Please try again.`);
                }
                window.location.reload();
              })
              .catch((error) => {
                console.error("Error:", error);
                alert("An error occured. Please try again.");
              });

            // Hide the modal after processing
            confirmationModal.classList.add("hidden");
            selectedLink = null;
          }
        });
      });
    </script>
  </body>
</html>

<!-- <script>
      const cancelLinks = document.querySelectorAll("a[id^='cancel-order-']");

      cancelLinks.forEach((link) => {
        link.addEventListener("click", function (event) {
          event.preventDefault();

          const orderId = this.getAttribute("data-order-id");
          const productId = this.getAttribute("data-product-id");
          console.log(orderId);

          // Send AJAX request to cancel the order
          fetch(`/user/cancelOrder/${orderId}?productId=${productId}`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
          })
            .then((response) => response.json())
            .then((data) => {
              if (data.success) {
                // Update the UI to reflect the cancellation
                this.parentElement.innerHTML =
                  '<p class="text-sm text-black leading-relaxed text-center md:text-left w-full">Order Cancelled</p>';
              } else {
                alert(`Failed to cancel the order. Please try again.`);
              }
            })
            .catch((error) => {
              console.error("Error:", error);
              alert("An error occured. Please try again.");
            });
        });
      });
    </script> -->

<!DOCTYPE html>
<html lang="en">
  <head>
    <!-- Head Boiler Plate -->
    <%- include('components/headboilerplate') %>

    <script src="https://www.paypal.com/sdk/js?client-id=<%= paypalClientId %>"></script>
  </head>
  <body class="flex flex-col min-h-screen">
    <!-- Navbar Section -->
    <%- include('components/navbar') %>

    <div
      id="order-success-modal"
      class="hidden fixed inset-0 p-4 flex flex-wrap justify-center items-center w-full h-full z-[1000] before:fixed before:inset-0 before:w-full before:h-full before:bg-[rgba(0,0,0,0.5)] overflow-auto font-[sans-serif]"
    >
      <div class="w-full max-w-lg bg-white shadow-lg rounded-lg p-6 relative">
        <div class="my-8 text-center">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            class="w-14 shrink-0 fill-green-500 inline"
            viewBox="0 0 512 512"
          >
            <path
              d="M383.841 171.838c-7.881-8.31-21.02-8.676-29.343-.775L221.987 296.732l-63.204-64.893c-8.005-8.213-21.13-8.393-29.35-.387-8.213 7.998-8.386 21.137-.388 29.35l77.492 79.561a20.687 20.687 0 0 0 14.869 6.275 20.744 20.744 0 0 0 14.288-5.694l147.373-139.762c8.316-7.888 8.668-21.027.774-29.344z"
              data-original="#000000"
            />
            <path
              d="M256 0C114.84 0 0 114.84 0 256s114.84 256 256 256 256-114.84 256-256S397.16 0 256 0zm0 470.487c-118.265 0-214.487-96.214-214.487-214.487 0-118.265 96.221-214.487 214.487-214.487 118.272 0 214.487 96.221 214.487 214.487 0 118.272-96.215 214.487-214.487 214.487z"
              data-original="#000000"
            />
          </svg>
          <h4 class="text-xl text-gray-800 font-semibold mt-4">
            Order Successfully accepted!
          </h4>
        </div>

        <button
          id="close-modal-button"
          type="button"
          class="px-5 py-2.5 w-full rounded-lg text-white text-sm border-none outline-none bg-submit-button hover:bg-gray-700"
        >
          Got it
        </button>
      </div>
    </div>

    <!-- Main Content Section -->
    <main class="flex flex-row mt-3">
      <div class="w-full ml-3">
        <section class="bg-white py-8 antialiase md:py-16">
          <form id="checkoutForm" class="mx-auto max-w-screen-xl px-4 2xl:px-0">
            <div class="flex justify-between border-b pb-8">
              <h1 class="font-semibold text-2xl">Checkout</h1>
            </div>
            <div
              class="mt-6 sm:mt-8 lg:flex lg:items-start lg:gap-12 xl:gap-16"
            >
              <div class="min-w-0 flex-1 space-y-8">
                <div class="space-y-4">
                  <h2 class="text-xl font-semibold text-black">
                    Delivery Address
                  </h2>

                  <div class="grid grid-cols-1 gap-4 sm:grid-cols-2">
                    <div>
                      <label
                        for="your_name"
                        class="mb-2 block text-sm font-medium text-black"
                      >
                        Your name
                      </label>
                      <input
                        type="text"
                        id="your_name"
                        class="block w-full rounded-lg border border-gray-300 bg-gray-50 p-2.5 text-sm text-black"
                        value="<%=user.first_name%> <%=user.second_name%>"
                        readonly
                        required
                      />
                    </div>

                    <div>
                      <label
                        for="your_email"
                        class="mb-2 block text-sm font-medium text-black"
                      >
                        Your email*
                      </label>
                      <input
                        type="email"
                        id="your_email"
                        class="block w-full rounded-lg border border-gray-300 bg-gray-50 p-2.5 text-sm text-black"
                        value="<%=user.email%>"
                        readonly
                        required
                      />
                    </div>

                    <div>
                      <label
                        for="phone-input-3"
                        class="mb-2 block text-sm font-medium text-black"
                      >
                        Phone Number*
                      </label>
                      <div class="flex items-center">
                        <button
                          id="dropdown-phone-button-3"
                          data-dropdown-toggle="dropdown-phone-3"
                          class="z-10 inline-flex shrink-0 items-center rounded-s-lg border border-gray-300 bg-gray-100 px-4 py-2.5 text-center text-sm font-medium text-black hover:bg-gray-200"
                          type="button"
                        >
                          +91
                        </button>

                        <div class="relative w-full">
                          <input
                            type="text"
                            id="phone-input"
                            class="z-20 block w-full rounded-e-lg border border-s-0 border-gray-300 bg-gray-50 p-2.5 text-sm text-black"
                            pattern="[0-9]{3}-[0-9]{3}-[0-9]{4}"
                            value="<%=user.phone_number%>"
                            readonly
                            required
                          />
                        </div>
                      </div>
                    </div>

                    <div>
                      <div class="mb-2 flex items-center gap-2">
                        <label
                          for="address_line"
                          class="block text-sm font-medium text-black"
                        >
                          Address*
                        </label>
                      </div>
                      <input
                        id="address_line"
                        type="text"
                        class="block w-full rounded-lg border border-gray-300 bg-gray-50 p-2.5 text-sm text-black"
                        value="<%=user.address[0].address_line_1%> <%=user.address[0].address_line_2%>"
                        readonly
                      />
                    </div>

                    <div>
                      <div class="mb-2 flex items-center gap-2">
                        <label
                          for="street"
                          class="block text-sm font-medium text-black"
                        >
                          Street*
                        </label>
                      </div>
                      <input
                        id="street"
                        type="text"
                        class="block w-full rounded-lg border border-gray-300 bg-gray-50 p-2.5 text-sm text-black"
                        value="<%=user.address[0].street%>"
                        readonly
                      />
                    </div>

                    <div>
                      <div class="mb-2 flex items-center gap-2">
                        <label
                          for="city"
                          class="block text-sm font-medium text-black"
                        >
                          City*
                        </label>
                      </div>
                      <input
                        id="city"
                        type="text"
                        class="block w-full rounded-lg border border-gray-300 bg-gray-50 p-2.5 text-sm text-black"
                        value="<%=user.address[0].city%>"
                        readonly
                      />
                    </div>

                    <div>
                      <div class="mb-2 flex items-center gap-2">
                        <label
                          for="state"
                          class="block text-sm font-medium text-black"
                        >
                          State*
                        </label>
                      </div>
                      <input
                        id="state"
                        type="text"
                        class="block w-full rounded-lg border border-gray-300 bg-gray-50 p-2.5 text-sm text-black"
                        value="<%=user.address[0].state%>"
                        readonly
                      />
                    </div>

                    <div>
                      <div class="mb-2 flex items-center gap-2">
                        <label
                          for="country"
                          class="block text-sm font-medium text-black"
                        >
                          Country*
                        </label>
                      </div>
                      <input
                        id="country"
                        type="text"
                        class="block w-full rounded-lg border border-gray-300 bg-gray-50 p-2.5 text-sm text-black"
                        value="<%=user.address[0].country%>"
                        readonly
                      />
                    </div>

                    <div>
                      <div class="mb-2 flex items-center gap-2">
                        <label
                          for="zip_code"
                          class="block text-sm font-medium text-black"
                        >
                          Zip-Code*
                        </label>
                      </div>
                      <input
                        id="zip_code"
                        type="text"
                        class="block w-full rounded-lg border border-gray-300 bg-gray-50 p-2.5 text-sm text-black"
                        value="<%=user.address[0].zip_code%>"
                        readonly
                      />
                    </div>

                    <div class="sm:col-span-2">
                      <button
                        type="button"
                        onclick="window.location.href='/user/addAddressPage';"
                        class="flex w-full items-center justify-center gap-2 rounded-lg border border-gray-200 bg-white px-5 py-2.5 text-sm font-medium text-black"
                      >
                        <svg
                          class="h-5 w-5"
                          aria-hidden="true"
                          xmlns="http://www.w3.org/2000/svg"
                          width="24"
                          height="24"
                          fill="none"
                          viewBox="0 0 24 24"
                        >
                          <path
                            stroke="currentColor"
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M5 12h14m-7 7V5"
                          />
                        </svg>
                        Add new address
                      </button>
                    </div>
                  </div>
                </div>

                <div class="space-y-4">
                  <h3 class="text-xl font-semibold text-black">Address</h3>

                  <div class="grid grid-cols-1 gap-4 md:grid-cols-3">
                    <% for( let i = 0; i < user.address.length; i++ ) { %>
                    <div
                      class="rounded-lg border border-gray-200 bg-gray-50 p-4 ps-4"
                    >
                      <div class="flex items-start">
                        <div class="flex h-5 items-center">
                          <input id="address-<%=i%>"
                          aria-describedby="address-text-<%=i%>" type="radio"
                          name="address-selection" value='<%=
                          JSON.stringify(user.address[i]) %>' class="h-4 w-4
                          border-gray-300 bg-white text-black" <% if (i === 0) {
                          %>checked<% } %> />
                        </div>

                        <div class="ms-4 text-sm">
                          <label
                            for="address-<%=i%>"
                            class="font-medium leading-none text-black"
                          >
                            Address <%=i+1%>
                          </label>
                          <p
                            id="address-text-<%=i%>"
                            class="mt-1 text-xs font-normal text-black"
                          >
                            <%=user.address[i].address_line_1%>
                            <%=user.address[i].address_line_2%> <br />
                            <%=user.address[i].street%>,
                            <%=user.address[i].city%>, <br />
                            <%=user.address[i].state%>
                            <%=user.address[i].country%>
                            <%=user.address[i].zip_code%>
                          </p>
                        </div>
                      </div>
                    </div>

                    <% } %>
                  </div>
                </div>

                <div class="space-y-4">
                  <h3 class="text-xl font-semibold text-black">Payment</h3>

                  <div class="grid grid-cols-1 gap-4 md:grid-cols-3">
                    <div
                      class="rounded-lg border border-gray-200 bg-gray-50 p-4 ps-4"
                    >
                      <div class="flex items-start">
                        <div class="flex h-5 items-center">
                          <input
                            id="upi"
                            aria-describedby="upi-text"
                            type="radio"
                            name="payment-method"
                            value=""
                            class="h-4 w-4 border-gray-300 bg-white text-black"
                          />
                        </div>

                        <div class="ms-4 text-sm"></div>
                        <div id="paypal-button-container"></div>
                      </div>
                    </div>

                    <div
                      class="rounded-lg border border-gray-200 bg-gray-50 p-4 ps-4"
                    >
                      <div class="flex items-start">
                        <div class="flex h-5 items-center">
                          <input
                            id="cod"
                            aria-describedby="cod-text"
                            type="radio"
                            name="payment-method"
                            value=""
                            class="h-4 w-4 border-gray-300 bg-white text-primary-600"
                            checked
                          />
                        </div>

                        <div class="ms-4 text-sm">
                          <label
                            for="cod"
                            class="font-medium leading-none text-black"
                          >
                            Cash On Delievery
                          </label>
                          <p
                            id="cod-text"
                            class="mt-1 text-xs font-normal text-black"
                          >
                            Please pay with cash
                          </p>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <div
                class="mt-6 w-full space-y-6 sm:mt-8 lg:mt-0 lg:max-w-xs xl:max-w-md"
              >
                <div class="flow-root">
                  <div
                    class="-my-3 divide-y divide-gray-200 dark:divide-gray-800"
                  >
                    <dl class="flex items-center justify-between gap-4 py-3">
                      <dt class="text-base font-normal text-black">Subtotal</dt>
                      <dd class="text-base font-medium text-black">
                        ₹<%=billSummary.subtotal%>
                      </dd>
                    </dl>

                    <dl class="flex items-center justify-between gap-4 py-3">
                      <dt class="text-base font-normal text-black">
                        Discounts
                      </dt>
                      <dd class="text-base font-medium text-green-500">
                        ₹<%=billSummary.discount%>
                      </dd>
                    </dl>

                    <dl class="flex items-center justify-between gap-4 py-3">
                      <dt class="text-base font-normal text-black">
                        Delievery Charge
                      </dt>
                      <dd class="text-base font-medium text-black">₹0</dd>
                    </dl>

                    <dl class="flex items-center justify-between gap-4 py-3">
                      <dt class="text-base font-normal text-black">GST</dt>
                      <dd class="text-base font-medium text-black">
                        ₹<%=billSummary.gst%>
                      </dd>
                    </dl>

                    <dl class="flex items-center justify-between gap-4 py-3">
                      <dt class="text-base font-bold text-black">
                        Grand Total
                      </dt>
                      <dd class="text-base font-bold text-black">
                        ₹<%=billSummary.grandTotal%>
                      </dd>
                    </dl>
                  </div>
                </div>

                <div class="space-y-3">
                  <button
                    type="button"
                    class="flex w-full items-center justify-center rounded-lg bg-submit-button px-5 py-2.5 text-sm font-medium text-white hover:bg-green-800"
                    id="place-order"
                  >
                    Place Order
                  </button>
                </div>
              </div>
            </div>
          </form>
        </section>
      </div>
    </main>

    <!-- Footer Section -->
    <%- include('components/footer') %>

    <script>
      paypal.Buttons({
        createOrder: function(data, actions) {
          return fetch('/user/create-paypal-order', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              totalAmount: 100.00  // Replace with dynamic amount
            })
            }).then(res => res.json())
              .then(order => order.id); // Return the order ID
          },
          onApprove: function(data, actions) {
              return fetch('/user/capture-paypal-order', {
                  method: 'POST',
                  headers: {
                      'Content-Type': 'application/json'
                  },
                  body: JSON.stringify({
                      orderId: data.orderID
                  })
              }).then(res => res.json())
                .then(details => {
                    alert('Transaction completed!');
                    window.location.href = '/order-success';
                });
          }
      }).render('#paypal-button-container');

        // Pass the products data to the front end as a JavaScript object
        const products = <%- JSON.stringify(products) %>;
        document
          .querySelectorAll('input[name="address-selection"]')
          .forEach((radio) => {
            radio.addEventListener("change", function () {
            const selectedAddress = JSON.parse(this.value);

            document.getElementById(
              "address_line"
            ).value = `${selectedAddress.address_line_1} ${selectedAddress.address_line_2}`;
            document.getElementById("street").value = selectedAddress.street;
            document.getElementById("city").value = selectedAddress.city;
            document.getElementById("state").value = selectedAddress.state;
            document.getElementById("country").value = selectedAddress.country;
            document.getElementById("zip_code").value =
              selectedAddress.zip_code;
              });
            });

        document
          .getElementById("place-order")
          .addEventListener("click", function () {
            // Get selected address
            const addressSelection = document.querySelector(
              'input[name="address-selection"]:checked'
            ).value;

            const address = JSON.parse(addressSelection);

            // Get payment method
            const paymentMethod = document.querySelector(
              'input[name="payment-method"]:checked'
            ).id;

            // Get bill summary
            const billSummary = {
              subtotal: "<%=billSummary.subtotal%>",
              discount: "<%=billSummary.discount%>",
              gst: "<%=billSummary.gst%>",
              grandTotal: "<%=billSummary.grandTotal%>",
            };

            // Prepare data to be sent to the server
            const data = {
              address,
              paymentMethod,
              billSummary,
              products
            };

            // Send the data via AJAX
            fetch("/user/checkout", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                },
                body: JSON.stringify(data),
              })
                .then((response) => {
                  // Return the parsed JSON data
                  return response.json();
                })
                .then((data) => {
                  if (data.success) {
                    // Show the success modal
                    document.getElementById("order-success-modal").classList.remove("hidden");
                  }
                })
                .catch((error) => {
                  console.error("Error:", error);
                  alert("An error occurred. Please try again.");
                });
              });

        // Select the modal and the close button
        const modal = document.getElementById('order-success-modal');
        const closeButton = document.getElementById('close-modal-button');

        // Add click event listener to the "Got it" button
        closeButton.addEventListener('click', () => {
          modal.classList.add('hidden');
          window.location.href = '/user/orderPage';
        });
    </script>
  </body>
</html>
